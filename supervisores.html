<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Supervisores - OPL Demo</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body {
      margin: 0;
      background: linear-gradient(135deg, #1F3B73, #2C82C9);
      font-family: 'Segoe UI', sans-serif;
      color: white;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    .top-bar {
      width: 100%;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(12px);
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      padding: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .top-bar select, .top-bar input[type="date"], .top-bar button {
      margin: 8px;
      padding: 12px 16px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      outline: none;
    }
    .top-bar select, .top-bar input[type="date"] {
      background: rgba(255, 255, 255, 0.8);
      color: #1F3B73;
      font-weight: 600;
    }
    .top-bar button {
      background-color: #FFC107;
      color: black;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .top-bar button:hover {
      background-color: #e0a800;
    }
    #map {
      flex: 1;
      width: 100%;
      border-top: 2px solid rgba(255,255,255,0.2);
    }
    /* Sidebar */
    #sidebar {
      position: fixed;
      top: 0;
      right: -320px;
      width: 320px;
      height: 100%;
      background: rgba(31, 59, 115, 0.9);
      backdrop-filter: blur(10px);
      transition: right 0.4s ease;
      overflow-y: auto;
      padding: 25px;
      z-index: 999;
      box-shadow: -4px 0 20px rgba(0,0,0,0.5);
    }
    #sidebar.open {
      right: 0;
    }
    #sidebar h3 {
      color: #FFC107;
      margin-top: 0;
      margin-bottom: 15px;
    }
    .point-item {
      background: rgba(255, 255, 255, 0.15);
      margin-bottom: 12px;
      padding: 12px;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.3s ease;
      font-size: 15px;
    }
    .point-item:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    #closeSidebar {
      background: #FFC107;
      color: black;
      border: none;
      border-radius: 8px;
      padding: 10px;
      font-weight: bold;
      cursor: pointer;
      width: 100%;
      margin-bottom: 15px;
    }
    .icono-ubicacion {
      margin-right: 8px;
      font-size: 18px;
    }
    /* EstadÃ­sticas pequeÃ±as */
    .stats {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
      margin-left: 10px;
    }
    .stats p {
      margin: 0 10px;
      font-weight: bold;
    }
  </style>
</head>

<body>

<div class="top-bar">
  <select id="operadorSelect">
    <option value="">-- Selecciona un operador --</option>
  </select>
  <input type="date" id="fechaFiltro">
  <button onclick="mostrarSidebar()">Ver Historial</button>
  <div class="stats">
    <p id="puntos">Puntos: 0</p>
    <p id="distancia">Distancia: 0 km</p>
  </div>
</div>

<div id="map"></div>

<div id="sidebar">
  <button id="closeSidebar" onclick="cerrarSidebar()">Cerrar</button>
  <h3>Historial de puntos</h3>
  <div id="historialPuntos"></div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBgVMJ4tZQ_0vnzobHCniKsM6dgjCyoauc",
    authDomain: "opl-demo-20e5d.firebaseapp.com",
    databaseURL: "https://opl-demo-20e5d-default-rtdb.firebaseio.com",
    projectId: "opl-demo-20e5d",
    storageBucket: "opl-demo-20e5d.appspot.com",
    messagingSenderId: "1015591087700",
    appId: "1:1015591087700:web:55e01976e950b8251707c1"
  };

  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();

  let map;
  let markers = {};
  let polylines = [];
  let coordenadasGlobal = [];

  function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 19.4326, lng: -99.1332 },
      zoom: 12
    });
    cargarOperadores();
    escucharUbicaciones();
  }

  function cargarOperadores() {
    const operadorSelect = document.getElementById("operadorSelect");
    operadorSelect.innerHTML = '<option value="">-- Selecciona un operador --</option>';

    database.ref("ubicaciones").once("value", snapshot => {
      snapshot.forEach(childSnapshot => {
        const numeroEmpleado = childSnapshot.key;
        const datos = childSnapshot.val();
        if (datos.puesto && datos.puesto.toUpperCase() === "OPERADOR") {
          const option = document.createElement("option");
          option.value = numeroEmpleado;
          option.text = `${numeroEmpleado} - ${datos.nombre}`;
          operadorSelect.appendChild(option);
        }
      });
    });

    operadorSelect.addEventListener("change", function() {
      const numeroEmpleado = this.value;
      if (numeroEmpleado) {
        centrarEnOperador(numeroEmpleado);
      }
    });
  }

  function escucharUbicaciones() {
    database.ref("ubicaciones").on("value", snapshot => {
      snapshot.forEach(childSnapshot => {
        const numeroEmpleado = childSnapshot.key;
        const datos = childSnapshot.val();
        if (datos.ubicacion && isFinite(datos.ubicacion.latitude) && isFinite(datos.ubicacion.longitude)) {
          const latLng = new google.maps.LatLng(datos.ubicacion.latitude, datos.ubicacion.longitude);
          if (markers[numeroEmpleado]) {
            markers[numeroEmpleado].setPosition(latLng);
          } else {
            const marker = new google.maps.Marker({
              position: latLng,
              map: map,
              title: `Operador ${numeroEmpleado}`,
              icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
            });
            markers[numeroEmpleado] = marker;
          }
        }
      });
    });
  }

  function centrarEnOperador(numeroEmpleado) {
    database.ref(`ubicaciones/${numeroEmpleado}/ubicacion`).once("value", snapshot => {
      if (snapshot.exists()) {
        const ubicacion = snapshot.val();
        if (isFinite(ubicacion.latitude) && isFinite(ubicacion.longitude)) {
          map.setCenter(new google.maps.LatLng(ubicacion.latitude, ubicacion.longitude));
          map.setZoom(17);
        }
      }
    });
  }

  function mostrarSidebar() {
    const numeroEmpleado = document.getElementById("operadorSelect").value;
    if (!numeroEmpleado) {
      alert("Selecciona un operador primero.");
      return;
    }
    const fechaFiltro = document.getElementById("fechaFiltro").value;

    document.getElementById('sidebar').classList.add('open');
    const historialDiv = document.getElementById("historialPuntos");
    historialDiv.innerHTML = '';

    coordenadasGlobal = [];

    database.ref(`historial/${numeroEmpleado}`).once("value", snapshot => {
      snapshot.forEach(childSnapshot => {
        const punto = childSnapshot.val();
        if (isFinite(punto.latitude) && isFinite(punto.longitude)) {
          const fechaPunto = new Date(punto.timestamp).toISOString().split('T')[0];
          if (!fechaFiltro || fechaPunto === fechaFiltro) {
            coordenadasGlobal.push({
              lat: punto.latitude,
              lng: punto.longitude,
              timestamp: punto.timestamp
            });
          }
        }
      });

      coordenadasGlobal.forEach((punto, index) => {
        const fechaHora = new Date(punto.timestamp).toLocaleString();
        const div = document.createElement("div");
        div.className = "point-item";
        div.innerHTML = `<span class="icono-ubicacion">ðŸ“Œ</span><strong>${fechaHora}</strong><br>Lat: ${punto.lat.toFixed(5)}, Lng: ${punto.lng.toFixed(5)}`;
        div.onclick = () => {
          map.setCenter(new google.maps.LatLng(punto.lat, punto.lng));
          map.setZoom(18);
        };
        historialDiv.appendChild(div);
      });

      document.getElementById('puntos').innerText = `Puntos: ${coordenadasGlobal.length}`;
    });
  }

  function cerrarSidebar() {
    document.getElementById('sidebar').classList.remove('open');
  }

  function loadGoogleMapsAPI() {
    const script = document.createElement("script");
    script.src = "https://maps.googleapis.com/maps/api/js?key=AIzaSyCn59s9KxlvxWIlB5_hm3L4-Tzwu2InbzE&callback=initMap";
    script.async = true;
    script.defer = true;
    document.head.appendChild(script);
  }
  window.onload = loadGoogleMapsAPI;
</script>

</body>
</html>
