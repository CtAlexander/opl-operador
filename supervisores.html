<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Supervisores - OPL demo</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body {
      margin: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: linear-gradient(135deg, #1F3B73 0%, #2C82C9 100%);
      font-family: 'Segoe UI', sans-serif;
      color: white;
      flex-direction: column;
    }
    .form-container {
      background: rgba(255, 255, 255, 0.1);
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
      text-align: center;
      width: 320px;
      margin-bottom: 20px;
    }
    h2 {
      margin-bottom: 20px;
    }
    select {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 8px;
      border: none;
      outline: none;
      font-size: 16px;
    }
    #map {
      width: 90%;
      height: 70vh;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>

<div class="form-container">
  <h2>Panel de Supervisores</h2>
  <select id="operadorSelect">
    <option value="">--Selecciona un operador--</option>
  </select>
</div>

<div id="map"></div>

<script>
  // Configuración Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyBgVMJ4tZQ_0vnzobHCniKsM6dgjCyoauc",
    authDomain: "opl-demo-20e5d.firebaseapp.com",
    databaseURL: "https://opl-demo-20e5d-default-rtdb.firebaseio.com",
    projectId: "opl-demo-20e5d",
    storageBucket: "opl-demo-20e5d.appspot.com",
    messagingSenderId: "1015591087700",
    appId: "1:1015591087700:web:55e01976e950b8251707c1"
  };

  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();

  let map;
  let markers = {};
  let polylines = [];

  function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
      center: { lat: 19.4326, lng: -99.1332 },
      zoom: 12
    });

    cargarOperadores();
    escucharUbicaciones();
  }

  function cargarOperadores() {
    const operadorSelect = document.getElementById("operadorSelect");
    operadorSelect.innerHTML = '<option value="">--Seleccionar--</option>';

    database.ref("ubicaciones").once("value", snapshot => {
      snapshot.forEach(childSnapshot => {
        const numeroEmpleado = childSnapshot.key;
        const datos = childSnapshot.val();

        if (datos.puesto && datos.puesto.toUpperCase() === "OPERADOR") {
          const option = document.createElement("option");
          option.value = numeroEmpleado;
          option.text = `${numeroEmpleado} - ${datos.nombre}`;
          operadorSelect.appendChild(option);
        }
      });
    });

    operadorSelect.addEventListener("change", function () {
      const numeroEmpleado = this.value;
      if (numeroEmpleado) {
        centrarEnOperador(numeroEmpleado);
        mostrarHistorial(numeroEmpleado);
      }
    });
  }

  function escucharUbicaciones() {
    database.ref("ubicaciones").on("value", snapshot => {
      snapshot.forEach(childSnapshot => {
        const numeroEmpleado = childSnapshot.key;
        const datos = childSnapshot.val();
        if (datos.ubicacion && isFinite(datos.ubicacion.latitude) && isFinite(datos.ubicacion.longitude)) {
          const latLng = new google.maps.LatLng(datos.ubicacion.latitude, datos.ubicacion.longitude);

          if (markers[numeroEmpleado]) {
            markers[numeroEmpleado].setPosition(latLng);
          } else {
            const marker = new google.maps.Marker({
              position: latLng,
              map: map,
              title: `Operador ${numeroEmpleado}`,
              icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png"
            });
            markers[numeroEmpleado] = marker;
          }
        }
      });
    });
  }

  function centrarEnOperador(numeroEmpleado) {
    database.ref(`ubicaciones/${numeroEmpleado}/ubicacion`).once("value", snapshot => {
      if (snapshot.exists()) {
        const ubicacion = snapshot.val();
        if (isFinite(ubicacion.latitude) && isFinite(ubicacion.longitude)) {
          const latLng = new google.maps.LatLng(ubicacion.latitude, ubicacion.longitude);
          map.setCenter(latLng);
          map.setZoom(17); // Zoom más cercano
        } else {
          alert('No se pudo obtener la ubicación del operador.');
        }
      }
    });
  }

  function mostrarHistorial(numeroEmpleado) {
    // Limpiar polilíneas anteriores
    polylines.forEach(polyline => polyline.setMap(null));
    polylines = [];

    database.ref(`historial/${numeroEmpleado}`).once("value", snapshot => {
      const coordenadas = [];
      snapshot.forEach(childSnapshot => {
        const punto = childSnapshot.val();
        if (isFinite(punto.latitud) && isFinite(punto.longitud)) {
          coordenadas.push({ lat: punto.latitud, lng: punto.longitud });
        }
      });

      if (coordenadas.length > 0) {
        const polyline = new google.maps.Polyline({
          path: coordenadas,
          geodesic: true,
          strokeColor: "#FF0000",
          strokeOpacity: 1.0,
          strokeWeight: 2
        });
        polyline.setMap(map);
        polylines.push(polyline);

        new google.maps.Marker({
          position: coordenadas[0],
          map: map,
          title: "Inicio",
          icon: "http://maps.google.com/mapfiles/ms/icons/green-dot.png"
        });

        new google.maps.Marker({
          position: coordenadas[coordenadas.length - 1],
          map: map,
          title: "Fin",
          icon: "http://maps.google.com/mapfiles/ms/icons/red-dot.png"
        });
      }
    });
  }

  function loadGoogleMapsAPI() {
    const script = document.createElement("script");
    script.src = "https://maps.googleapis.com/maps/api/js?key=AIzaSyCn59s9KxlvxWIlB5_hm3L4-Tzwu2InbzE&callback=initMap";
    script.async = true;
    script.defer = true;
    document.head.appendChild(script);
  }
  window.onload = loadGoogleMapsAPI;

 //HISTORIAL 
function mostrarHistorial(numeroEmpleado) {
  // Limpiar polilíneas anteriores
  polylines.forEach(polyline => polyline.setMap(null));
  polylines = [];

  database.ref(`historial/${numeroEmpleado}`).once("value", snapshot => {
    const coordenadas = [];
    snapshot.forEach(childSnapshot => {
      const punto = childSnapshot.val();
      if (isFinite(punto.latitude) && isFinite(punto.longitude)) {
        coordenadas.push({ lat: punto.latitude, lng: punto.longitude });
      }
    });

    if (coordenadas.length > 0) {
      // Dibujar polilínea del recorrido
      const polyline = new google.maps.Polyline({
        path: coordenadas,
        geodesic: true,
        strokeColor: "#FF0000",
        strokeOpacity: 1.0,
        strokeWeight: 2
      });
      polyline.setMap(map);
      polylines.push(polyline);

      // Marcar inicio (verde)
      new google.maps.Marker({
        position: coordenadas[0],
        map: map,
        title: "Inicio del recorrido",
        icon: "http://maps.google.com/mapfiles/ms/icons/green-dot.png"
      });

      // Marcar final (rojo)
      new google.maps.Marker({
        position: coordenadas[coordenadas.length - 1],
        map: map,
        title: "Fin del recorrido",
        icon: "http://maps.google.com/mapfiles/ms/icons/red-dot.png"
      });

      // Buscar la ubicación actual y marcarla (gris)
      database.ref(`ubicaciones/${numeroEmpleado}/ubicacion`).once("value", snapshot => {
        if (snapshot.exists()) {
          const actual = snapshot.val();
          if (isFinite(actual.latitude) && isFinite(actual.longitude)) {
            new google.maps.Marker({
              position: { lat: actual.latitude, lng: actual.longitude },
              map: map,
              title: "Ubicación actual",
              icon: "http://maps.google.com/mapfiles/ms/icons/grey-dot.png"
            });
          }
        }
      });

      // Centrar mapa en el último punto del historial
      map.setCenter(coordenadas[coordenadas.length - 1]);
      map.setZoom(16);
    } else {
      alert("Este operador no tiene historial disponible.");
    }
  });
}


</script>

</body>
</html>
